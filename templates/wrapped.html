<style>
    body {
        overflow: hidden; /* Prevents the main scrollbar from showing */
    }

    .slide-container {
        display: flex;
        flex-direction: column; /* Stack slides vertically */
        height: 100vh; /* Full viewport height */
        overflow-y: scroll; /* Enable vertical scrolling */
    }

    .slide {
        flex: 0 0 100%; /* Each slide takes full height */
        display: flex;
        flex-direction: column;
        justify-content: center; /* Center content vertically */
        align-items: center; /* Center content horizontally */
        padding: 20px; /* Optional padding */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Optional shadow for depth */
    }
    
</style>


<div class="slide-container">
    <div class="slide">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
            <h1 style="font-size: 60px;">{{ user_data.display_name }}'s</h1>
            <h1 style="font-size: 60px; margin-top: -40px;">Wrapped</h1>
             <img src="{{ user_data.images.0.url }}" alt="Profile Picture"
                style="border-radius: 150px; width: 300px;"/>
        </div>

        {% if selected_time_range == 'short_term' %}
            <h2>This is your Wrapped for the past month.</h2>
        {% elif selected_time_range == 'medium_term' %}
            <h2>This is your Wrapped for the past 6 months.</h2>
        {% elif selected_time_range == 'long_term' %}
            <h2>This is your Wrapped for the past year.</h2>
        {% endif %}
    </div>

    <div class="slide">
        <h2>Vibemeter</h2>
        <p>{{ average_valence }}Â°F</p>
        {% if average_valence <= 25 %}
            <h2>Your beats have MELANCHOLY vibes</h2>
        {% elif average_valence <= 50 %}
            <h2>Your beats have CHILL vibes</h2>
        {% elif average_valence <= 75 %}
            <h2>Your beats have PLEASANT vibes</h2>
        {% else %}
            <h2>Your beats have HYPE vibes</h2>
        {% endif %}
    </div>

    <div class="slide" style="align-items: flex-end; padding-right: 50px;">
        <div style="width: 20%; text-align: right; margin-right: 100px;">
            <h1 style="font-size: 125px;">Top</h1>
            <h1 style="font-size: 175px; margin-top: -75px; margin-bottom: -100px;">5</h1>
        </div>
        <div style="width: 20%; text-align: right; margin-right: 200px;">
            <h1 style="font-size: 125px;">Tracks</h1>
        </div>
    </div>

    <div class="slide">
        <div style="width: 40%; margin: auto;">
            <ol id="track-list" style="list-style-position: inside; padding-left: 0;">
                {% for track in top_tracks.items|slice:":5" %}
                    <li style="display: flex; align-items: center; flex-direction: {% if forloop.first %}column{% else %}row{% endif %};
                            text-align: center; margin-bottom: 15px; {% if forloop.first %} font-size: 1.5em; {% endif %}">

                        {% if track.album.images.0.url %}
                            <div style="width: {% if forloop.first %}120px{% else %}50px{% endif %}; height: {% if forloop.first %}120px{% else %}50px{% endif %};
                                        margin-bottom: {% if forloop.first %}10px{% else %}0{% endif %};
                                        margin-right: {% if forloop.first %}0px{% else %}15px{% endif %};">
                                <img src="{{ track.album.images.0.url }}" alt="Album Cover"
                                     style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        {% endif %}

                        <div style="{% if forloop.first %}margin-top: 10px;{% endif %}">
                            {{ track.name }}
                            {% if not forloop.first %} {% endif %}
                            {% if track.artists %}
                                - {{ track.artists.0.name }}
                            {% else %}
                                Unknown Artist
                            {% endif %}
                        </div>
                    
                            <audio class="track-audio">
                                <source src="{{ track.preview_url }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                    </li>
                {% endfor %}
            </ol>
        </div>
    </div>

    <div class="slide" style="align-items: flex-start;">
        <div style="justify-content: left; margin-left: 40px; width: 10%;">
            <h1 style="font-size: 125px">Top</h1>
            <h1 style="font-size: 175px; margin-top: -100px; margin-bottom: -100px;">5</h1>
            <h1 style="font-size: 125px">Artists</h1>
        </div>
    </div>

    <div class="slide">
        {% for artist, preview_url in artist_songs.items %}
            <audio class="artist-audio">
                <source src="{{ preview_url }}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        {% endfor %}
        <div style="text-align: center;">
            <ul style="list-style-type: none; padding: 0;">
                {% if top_artists %}
                    <li style="margin-bottom: 20px;">
                        {% if top_artists.items.0.images.0.url %}
                            <img src="{{ top_artists.items.0.images.0.url }}" alt="Top Artist Picture"
                                 style="width: 120px; height: 120px; object-fit: cover; margin-bottom: 10px;">
                        {% endif %}
                        <div style="font-size: 1.5em;">{{ top_artists.items.0.name }}</div>
                    </li>
                    <li>
                        <div style="display: flex; justify-content: center; align-items: center;">
                            {% for artist in top_artists.items|slice:"1:5" %}
                                <div style="margin: 0 10px; text-align: center;">
                                    {% if artist.images.0.url %}
                                        <img src="{{ artist.images.0.url }}" alt="Artist Picture"
                                             style="width: 50px; height: 50px; object-fit: cover; margin-bottom: 5px;">
                                    {% endif %}
                                    <div>{{ forloop.counter|add:1 }}. {{ artist.name }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </li>
                {% else %}
                    <p>No top artists available.</p>
                {% endif %}
            </ul>
        </div>
    </div>

    <div class="slide" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <div style="text-align: center;">
            <h1 style="font-size: 125px;">Favorite</h1>
            <h1 style="font-size: 125px; margin-top: -50px;">Genres</h1>
        </div>
    </div>

    <div class="slide">
        {% for genre, song_url in genre_songs.items %}
            <audio class="genre-audio">
                <source src="{{ song_url }}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        {% endfor %}
    
        <h3 style="text-align: center;">Top Genres</h3>

        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            {% if top_genres %}
                <p style="font-size: 1.5em; text-align: center;">Your top genre: {{ top_genres.0 }}</p>
            {% else %}
                <p>No top genres available.</p>
            {% endif %}
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; justify-items: center;">
            {% if top_genres %}
                {% for genre in top_genres|slice:":5" %}
                    {% if forloop.counter > 1 %}
                        <div style="border: 1px solid black; padding: 10px; text-align: center; width: 100%; max-width: 150px;">
                            <p>{{ genre }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p>No top genres available.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Function to play and stop audio based on visibility of the slide
    function playAudioOnSlide(slideIndex, tracksSelector) {
        const slide = document.querySelectorAll('.slide')[slideIndex]; // Get the slide at the specific index
        const audios = slide.querySelectorAll(tracksSelector); // Get the audio elements inside the slide
        let index = 0;

        // Play next track function
        function playNext() {
            if (index < audios.length) {
                audios[index].play().then(() => {
                    audios[index].onended = function () {
                        index++;
                        playNext(); // Continue playing next track when the current track ends
                    };
                }).catch(err => {
                    console.error('Error playing audio:', err);
                    index++;
                    playNext(); // Skip to next track if there's an error
                });
            }
        }

        // Stop all audios
        function stopAudio() {
            audios.forEach(audio => {
                audio.pause();
                audio.currentTime = 0; // Reset the audio to the beginning
            });
        }

        // Set up Intersection Observer to trigger playback when the slide is in view and stop when out of view
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) { // If the slide is visible
                    playNext();
                } else { // If the slide is no longer visible
                    stopAudio();
                }
            });
        }, {threshold: 0.5}); // Trigger when 50% of the slide is visible

        observer.observe(slide); // Start observing the slide
    }

    // Automatically play top tracks when the slide becomes visible
    playAudioOnSlide(3, '.track-audio'); // Slide index 3 is where the top tracks are
    // Automatically play top artist songs when the slide becomes visible
    playAudioOnSlide(5, '.artist-audio'); // Slide index 5 is where the top artists are
    // Automatically play top genre songs when the slide becomes visible
    playAudioOnSlide(7, '.genre-audio'); // Slide index 7 is where the top genres are

</script>
