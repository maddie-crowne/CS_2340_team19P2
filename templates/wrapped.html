<!DOCTYPE html>
{% load i18n %}
<html data-wf-page="6723cad8d690591d3bfe6e2b" data-wf-site="671a91359e3597b13381098d"
      lang="{% get_current_language as language_code %}">
<head>
    <meta charset="utf-8">
    <title>Wrapped</title>
    <meta content="Wrapped" property="og:title">
    <meta content="Wrapped" property="twitter:title">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="Webflow" name="generator">
    {% load static %}
    <link rel="stylesheet" href="{% static 'normalize-wrapped-2.css' %}">
    <link rel="stylesheet" href="{% static 'webflow-wrapped-2.css' %}">
    <link rel="stylesheet" href="{% static 'spotify-wrapped-2.webflow.css' %}">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
    <script type="text/javascript">WebFont.load({google: {families: ["Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic", "Varela Round:400", "Open Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic"]}});</script>
    <script type="text/javascript">
        /**
         * This script adds classes to the HTML document element based on the environment
         * (JavaScript support and touch capability), and includes links to favicon and Apple touch icon.
         *
         * 1. Adds a "js" class if JavaScript is supported.
         * 2. Adds a "touch" class if the device supports touch events.
         * 3. Sets favicon and Apple touch icon links in the HTML head.
         *
         * @function
         * @param {Window} o - The global `window` object.
         * @param {Document} c - The global `document` object.
         */
        !function (o, c) {
            // Get the root document element
            var n = c.documentElement,
                // Define a prefix for classes
                t = " w-mod-";

            // Add 'js' class to indicate JavaScript support
            n.className += t + "js";

            // Check if the device supports touch events (for touch devices)
            if ("ontouchstart" in o || o.DocumentTouch && c instanceof DocumentTouch) {
                // Add 'touch' class for touch-enabled devices
                n.className += t + "touch";
            }
        }(window, document);</script>
    <link href="../wrapped/static/images/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="../wrapped/static/images/webclip.png" rel="apple-touch-icon">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        /**
         * jQuery script for managing dropdown behavior.
         *
         * This script adds functionality to toggle a dropdown menu when clicking a button,
         * close the dropdown when clicking outside, and prevent closing the dropdown when
         * clicking inside it.
         */
        $(document).ready(function () {
            /**
             * Toggles the visibility of the dropdown when clicking the dropdown toggle button.
             *
             * This function listens for a click event on elements with the class `.w-dropdown-toggle`.
             * When clicked, it adds or removes the `open` class on the closest `.w-dropdown` element,
             * thus toggling its visibility.
             *
             * @function
             * @param {Event} event - The click event triggered when the toggle button is clicked.
             */
            $('.w-dropdown-toggle').click(function (event) {
                $(this).closest('.w-dropdown').toggleClass('open');
                event.stopPropagation();  // Prevents the click event from propagating to the document
            });

            /**
             * Closes any open dropdown when clicking anywhere outside of a dropdown.
             *
             * This function listens for click events on the document. If the click occurs outside
             * of any dropdown (i.e., the click target is not a descendant of `.w-dropdown`), it removes
             * the `open` class from all dropdowns, effectively closing them.
             *
             * @function
             * @param {Event} event - The click event triggered on the document.
             */
            $(document).click(function (event) {
                if (!$(event.target).closest('.w-dropdown').length) {
                    // If the click was outside the dropdown, close it
                    $('.w-dropdown').removeClass('open');
                }
            });

            /**
             * Prevents the dropdown from closing when clicking inside the dropdown itself.
             *
             * This function listens for click events on elements with the class `.w-dropdown`.
             * It stops the event from propagating to the document, preventing the dropdown from
             * being closed if the user clicks anywhere inside it.
             *
             * @function
             * @param {Event} event - The click event triggered inside the dropdown.
             */
            $('.w-dropdown').click(function (event) {
                event.stopPropagation();  // Prevents the event from reaching the document click handler
            });
        });
    </script>

    <!-- Custom CSS to show language dropdown -->
    <style>
        .w-dropdown-list {
            display: none;
        }

        .w-dropdown.open .w-dropdown-list {
            display: block;
        }
    </style>
</head>
<body class="body-8">
<div class="navbar-logo-center">
    <div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease"
         role="banner" class="navbar-logo-center-container shadow-three w-nav">
        <div class="navbar-wrapper-three">
            <ul role="list" class="nav-menu-block-2 w-list-unstyled">
                <li>
                    <a href="{% url 'wrapped:contact_developers' %}" class="nav-link-2">{% trans "Contact Us" %}</a>
                </li>
                <li>
                    <a href="{% url 'wrapped:invite' %}" class="nav-link-2">{% trans "Invite" %}</a>
                </li>
                <li>
                    <div data-hover="true" data-delay="0" class="nav-dropdown-2 w-dropdown">
                        <div class="nav-dropdown-toggle-2 w-dropdown-toggle">
                            <div class="nav-dropdown-icon-2 w-icon-dropdown-toggle"></div>
                            <div class="text-block-13">{{ language_code|upper }}</div>
                        </div>
                        <nav class="nav-dropdown-list-2 shadow-three mobile-shadow-hide w-dropdown-list">
                            <!-- Language switch form -->
                            <form action="{% url 'set_language' %}" method="POST">
                                {% csrf_token %}
                                <button type="submit" name="language" value="en"
                                        class="nav-dropdown-link-2 w-dropdown-link">EN
                                </button>
                                <button type="submit" name="language" value="es"
                                        class="nav-dropdown-link-2 w-dropdown-link">ES
                                </button>
                                <button type="submit" name="language" value="fr"
                                        class="nav-dropdown-link-2 w-dropdown-link">FR
                                </button>
                            </form>
                        </nav>
                    </div>
                </li>
            </ul>
            <div class="text-block">
                <a href="{% url 'wrapped:select' %}" style="color: white; text-decoration: none;">[ Wrapped ]</a>
            </div>
            <section class="flex-block-2">
                <a href="{% url 'wrapped:account' %}" class="button-5 w-button">Button Text</a>
            </section>
            <div class="menu-button-2 w-nav-button"></div>
        </div>
        <div class="menu-button-2 w-nav-button"></div>
    </div>
</div>

<div class="div-block-17 slide">
    <div>
        <div class="text-block-16">{{ user_data.display_name }}'s<br>Wrapped<br></div>
        <img class="w-layout-blockcontainer container-7 w-container" src="{{ user_data.images.0.url }}"
             alt="Profile Picture"/>
    </div>
    <div class="div-block-14">
        <div class="text-block-17">
            {% if selected_time_range == 'short_term' %}
                <h2>{% trans "This is your Wrapped for the past month." %}</h2>
            {% elif selected_time_range == 'medium_term' %}
                <h2>{% trans "This is your Wrapped for the past 6 months." %}</h2>
            {% elif selected_time_range == 'long_term' %}
                <h2>{% trans "This is your Wrapped for the past year." %}</h2>
            {% endif %}
        </div>
    </div>
</div>

<section class="vibemeter slide">
    <div id="w-node-a8aa89f5-f97e-62f7-7808-028ccdcd077c-03f32f7d" class="w-layout-layout quick-stack wf-layout-layout">
        <div id="w-node-f5fcd57c-1b18-4ea5-c562-cb2457096fbd-03f32f7d" class="w-layout-cell cell-4">
            <img src="{% static 'images/Spotify-Wrapped-Project-Page-Design-9.png' %}" loading="lazy" alt=""
                 class="image-15">
        </div>
        <div id="w-node-_51decf29-4233-4b7d-caec-5b525687697c-03f32f7d" class="w-layout-cell">
            <div class="text-block-19">72Â°F</div>
        </div>
        <div id="w-node-_6be5a1f2-a0e8-0ffc-044c-230ce4b2100c-03f32f7d" class="w-layout-cell">
            <div class="text-block-20">{% trans "your mix has <br>LOVELY<br>vibes" %}</div>
        </div>
    </div>
</section>

<section class="section-4 slide">
    <div class="text-block-21">{% trans "TOP" %}</div>
    <div class="text-block-22">5</div>
    <div class="text-block-21">{% trans "TRACKS" %}</div>
</section>

<section class="top-tracks-display slide">

    {% for track in top_tracks.items|slice:"5" %}
        <audio class="track-audio">
            <source src="{{ track.preview_url }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    {% endfor %}

    <div>
        <div class="w-layout-blockcontainer container-10 w-container">
            <div class="text-block-34-copy-copy-copy">{% trans "Your Top Track" %}</div>
            <img src="{{ top_tracks.items.0.album.images.0.url }}" loading="lazy" width="342" alt="" class="image-17">
            <div style="white-space: nowrap; font-size: 45px" class="text-block-35-copy-copy-copy">
                {{ top_tracks.items.0.name }}
            </div>
        </div>
    </div>

    <div id="w-node-aa728235-21a6-0168-19fc-9fbd47726da5-03f32f7d"
         class="w-layout-layout quick-stack-5 wf-layout-layout">
        {% for track in top_tracks.items|slice:"1:5" %}
            <div id="w-node-aa728235-21a6-0168-19fc-9fbd47726da6-03f32f7d" class="w-layout-cell">
                <div class="text-block-100-copy">#{{ forloop.counter|add:1 }}</div>
            </div>
            <div id="w-node-aa728235-21a6-0168-19fc-9fbd47726da7-03f32f7d" class="w-layout-cell cell-6">
                <img src="{{ track.album.images.0.url }}" loading="lazy" width="94" alt="" class="image-16"></div>
            <div id="w-node-_13a727dc-c2b8-dab1-ee06-47de9f1b01d9-03f32f7d" class="w-layout-cell cell-5">
                <div style="white-space: nowrap;" class="text-block-35-copy-copy">
                    {{ track.name }}
                </div>
            </div>
        {% endfor %}
    </div>
</section>

<section class="section-4-artists slide">
    <div class="text-block-23">{% trans "TOP" %}</div>
    <div class="text-block-24">5</div>
    <div class="text-block-23">{% trans "ARTISTS" %}</div>
</section>

<section class="top-5-artists-display slide">

    {% for artist, preview_url in artist_songs.items %}
        <audio class="artist-audio">
            <source src="{{ preview_url }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    {% endfor %}

    <div class="div-block-27">
        {% if top_artists.items.0.images.0.url %}
            <div class="w-layout-blockcontainer container-10 w-container">
                <div class="text-block-34-copy-copy-copy">{% trans "Your Top Artist" %}</div>
                <img src="{{ top_artists.items.0.images.0.url }}" width="342" alt="" class="image-17">
                <div style="white-space: nowrap;"
                     class="text-block-35-copy-copy-copy">{{ top_artists.items.0.name }}</div>
            </div>
            </div>
        {% endif %}

    <div id="w-node-f3217001-133c-434b-e208-31109b8b70ac-03f32f7d"
         class="w-layout-layout quick-stack-5 wf-layout-layout">
        {% for artist in top_artists.items|slice:"1:5" %}
            <div id="w-node-f3217001-133c-434b-e208-31109b8b70ad-03f32f7d" class="w-layout-cell">
                <div class="text-block-100-copy">#{{ forloop.counter|add:1 }}</div>
            </div>
            <div id="w-node-f3217001-133c-434b-e208-31109b8b70b0-03f32f7d" class="w-layout-cell cell-6">
                {% if artist.images.0.url %}
                    <img src="{{ artist.images.0.url }}" loading="lazy" width="94" alt="" class="image-16">
                {% endif %}
            </div>
            <div id="w-node-f3217001-133c-434b-e208-31109b8b70b2-03f32f7d" class="w-layout-cell cell-5">
                <div style="white-space: nowrap;" class="text-block-35-copy-copy">{{ artist.name }}</div>
            </div>
        {% endfor %}
</section>

<section class="section-6 slide">
    <div class="text-block-25" style="margin-top: 300px">{% trans "FAVORITE" %}</div>
    <div class="text-block-25">{% trans "GENRES" %}</div>
</section>

<section class="fav-genres-display slide">

    {% for genre, song_url in genre_songs.items %}
        <audio class="genre-audio">
            <source src="{{ song_url }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    {% endfor %}

    <div class="div-block-26">
        <div class="text-block-36">{% trans "Your Favorite Genres" %}</div>
        {% if top_genres %}
            <div style="white-space: nowrap;" class="text-block-38">#1 {{ top_genres.0 }}</div>
        {% else %}
            <p class="genre-title">No top genres available.</p>
        {% endif %}
    </div>
    <div id="w-node-_557df5fe-e4c9-eed1-29e4-b04c0e637bad-03f32f7d" class="w-layout-cell">
        {% if top_genres %}
            {% for genre in top_genres|slice:":5" %}
                {% if forloop.counter > 1 %}
                    <div style="white-space: nowrap;" class="text-block-34">#{{ forloop.counter }} {{ genre }}</div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="no-genres">No top genres available.</p>
        {% endif %}
    </div>

</section>

<script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=671a91359e3597b13381098d"
        type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
<script src="{% static 'webflow-wrapped.js' %}" type="text/javascript"></script>

</body>
</html>

<script>
    /**
     * Plays and stops audio tracks based on the visibility of a slide.
     * When the slide becomes visible in the viewport, the audio tracks within the slide start playing sequentially.
     * When the slide is no longer visible, the audio stops and resets.
     * 
     * @param {number} slideIndex - The index of the slide to observe (0-based).
     * @param {string} tracksSelector - The CSS selector to target the audio elements within the slide.
     */
    function playAudioOnSlide(slideIndex, tracksSelector) {
        const slide = document.querySelectorAll('.slide')[slideIndex]; // Get the slide at the specific index
        const audios = slide.querySelectorAll(tracksSelector); // Get the audio elements inside the slide
        let index = 0;

        /**
         * Plays the next audio track in the list.
         * When one track ends, the next one is played automatically.
         * If there's an error in playing the track, it skips to the next one.
         */
        function playNext() {
            if (index < audios.length) {
                audios[index].play().then(() => {
                    audios[index].onended = function () {
                        index++;
                        playNext(); // Continue playing next track when the current track ends
                    };
                }).catch(err => {
                    console.error('Error playing audio:', err);
                    index++;
                    playNext(); // Skip to next track if there's an error
                });
            }
        }

        /**
         * Stops all audio tracks and resets their playback to the beginning.
         */
        function stopAudio() {
            audios.forEach(audio => {
                audio.pause();
                audio.currentTime = 0; // Reset the audio to the beginning
            });
        }

        /**
         * Intersection Observer callback to start playing audio when the slide is in view and stop when out of view.
         *
         * @param {IntersectionObserverEntry[]} entries - Array of entries being observed.
         * @param {IntersectionObserver} observer - The IntersectionObserver instance.
         */
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) { // If the slide is visible
                    playNext();
                } else { // If the slide is no longer visible
                    stopAudio();
                }
            });
        }, {threshold: 0.5}); // Trigger when 50% of the slide is visible

        observer.observe(slide); // Start observing the slide
    }

    // Automatically play top tracks when the slide becomes visible
    playAudioOnSlide(3, '.track-audio'); // Slide index 3 is where the top tracks are
    // Automatically play top artist songs when the slide becomes visible
    playAudioOnSlide(5, '.artist-audio'); // Slide index 5 is where the top artists are
    // Automatically play top genre songs when the slide becomes visible
    playAudioOnSlide(7, '.genre-audio'); // Slide index 7 is where the top genres are
</script>
